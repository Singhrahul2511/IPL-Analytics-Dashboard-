<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced IPL Analytics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</head>
<body class="bg-light">
<div class="container-fluid">
    <div class="row">
        <nav id="sidebar" class="col-md-4 col-lg-3 d-md-block bg-white sidebar collapse">
            <div class="position-sticky pt-3">
                <div class="d-flex justify-content-between align-items-center px-3 mt-2 mb-3">
                    <h4 class="sidebar-heading text-primary">IPL Analytics</h4>
                    <button id="clear-filters-btn" class="btn btn-sm btn-outline-secondary">Clear</button>
                </div>

                <div class="filter-section">
                    <h6 class="text-muted">Team Head-to-Head</h6>
                    <form id="team-h2h-form">
                        <select name="team1" class="form-select form-select-sm mb-2 choices-select" required><option value="">Select Team 1</option>{% for team in teams %} <option value="{{ team }}">{{ team }}</option> {% endfor %}</select>
                        <select name="team2" class="form-select form-select-sm mb-2 choices-select" required><option value="">Select Team 2</option>{% for team in teams %} <option value="{{ team }}">{{ team }}</option> {% endfor %}</select>
                        <select name="season" class="form-select form-select-sm mb-2"><option value="All">All Seasons</option>{% for season in seasons %} <option value="{{ season }}">{{ season }}</option> {% endfor %}</select>
                        <select name="venue" class="form-select form-select-sm mb-2"><option value="All">All Venues</option>{% for venue in venues %} <option value="{{ venue }}">{{ venue }}</option> {% endfor %}</select>
                        <button type="submit" class="btn btn-primary btn-sm w-100">Analyze Team H2H</button>
                    </form>
                </div>

                <div class="filter-section">
                    <h6 class="text-muted">Overall Player Analysis</h6>
                    <form id="player-stats-form">
                        <input type="text" name="player" class="form-control form-control-sm mb-2" placeholder="Player Name (e.g., V Kohli)">
                        <select name="role" class="form-select form-select-sm mb-2"><option value="batsman">Batsman</option><option value="bowler">Bowler</option></select>
                        <button type="submit" class="btn btn-primary btn-sm w-100">Get Player Stats</button>
                    </form>
                </div>

                <div class="filter-section">
                    <h6 class="text-muted">Player vs Bowler</h6>
                    <form id="player-h2h-form">
                        <input type="text" name="batsman" class="form-control form-control-sm mb-2" placeholder="Batsman Name">
                        <input type="text" name="bowler" class="form-control form-control-sm mb-2" placeholder="Bowler Name">
                        <button type="submit" class="btn btn-primary btn-sm w-100">Analyze Player H2H</button>
                    </form>
                </div>

                <div class="filter-section">
                   <h6 class="text-muted">Venue Fortress</h6>
                   <form id="venue-fortress-form">
                       <select name="team" class="form-select form-select-sm mb-2 choices-select"><option value="">Select a Team</option>{% for team in teams %} <option value="{{ team }}">{{ team }}</option> {% endfor %}</select>
                       <button type="submit" class="btn btn-primary btn-sm w-100">Analyze Venues</button>
                   </form>
               </div>

                <div class="filter-section">
                    <h6 class="text-muted">Win Predictor</h6>
                    <form id="win-predictor-form">
                        <select name="team1" class="form-select form-select-sm mb-2 choices-select" required><option value="">Select Batting Team</option>{% for team in teams %} <option value="{{ team }}">{{ team }}</option> {% endfor %}</select>
                        <select name="team2" class="form-select form-select-sm mb-2 choices-select" required><option value="">Select Bowling Team</option>{% for team in teams %} <option value="{{ team }}">{{ team }}</option> {% endfor %}</select>
                        <select name="venue" class="form-select form-select-sm mb-2 choices-select" required><option value="">Select Venue</option>{% for venue in venues %} <option value="{{ venue }}">{{ venue }}</option> {% endfor %}</select>
                        <select name="toss_winner" class="form-select form-select-sm mb-2 choices-select" required><option value="">Toss Winner</option>{% for team in teams %} <option value="{{ team }}">{{ team }}</option> {% endfor %}</select>
                        <select name="toss_decision" class="form-select form-select-sm mb-2" required><option value="">Toss Decision</option><option value="field">Field</option><option value="bat">Bat</option></select>
                        <button type="submit" class="btn btn-primary btn-sm w-100">Predict</button>
                    </form>
                </div>
            </div>
        </nav>

        <main class="col-md-8 ms-sm-auto col-lg-9 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 id="main-title" class="h2">Dashboard</h1>
                <div>
                    <a href="https://github.com/Singhrahul2511" target="_blank" class="text-secondary ms-3 fs-4" title="GitHub">
                        <i class="bi bi-github"></i>
                    </a>
                    <a href="https://www.linkedin.com/in/rahul-kumar-8ab740268/" target="_blank" class="text-secondary ms-3 fs-4" title="LinkedIn">
                        <i class="bi bi-linkedin"></i>
                    </a>
                </div>
                </div>
            <div id="loader" class="d-none text-center mt-5">
                </div>
            <div id="results-container" class="row">
                </div>
        </main>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const resultsContainer = document.getElementById('results-container');
    const mainTitle = document.getElementById('main-title');
    const loader = document.getElementById('loader');
    const choicesElements = document.querySelectorAll('.choices-select');
    choicesElements.forEach(el => new Choices(el, { searchEnabled: true, itemSelectText: '' }));

    const showLoader = () => loader.classList.remove('d-none');
    const hideLoader = () => loader.classList.add('d-none');
    const renderError = (message) => { resultsContainer.innerHTML = `<div class="col-12"><div class="alert alert-danger">${message}</div></div>`; };
    const renderTable = (title, data) => {
        let tableHtml = `<h5 class="mt-3">${title}</h5><table class="table table-sm table-striped">`;
        for (const [key, value] of Object.entries(data)) { tableHtml += `<tr><th>${key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</th><td>${value}</td></tr>`; }
        return tableHtml + '</table>';
    };
    const renderPlot = (divId, data, layout) => Plotly.newPlot(divId, data, layout, { responsive: true });

    document.getElementById('clear-filters-btn').addEventListener('click', () => {
        document.querySelectorAll('form').forEach(form => form.reset());
        resultsContainer.innerHTML = `<div class="col-12"><p class="text-muted">Select filters from the sidebar to view analytics.</p></div>`;
        mainTitle.textContent = "Dashboard";
    });

    // --- Team H2H Handler ---
    document.getElementById('team-h2h-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const team1 = this.elements.team1.value;
        const team2 = this.elements.team2.value;
        if (!team1 || !team2 || team1 === team2) { renderError("Please select two different teams."); return; }
        mainTitle.textContent = `H2H: ${team1} vs ${team2}`;
        resultsContainer.innerHTML = '';
        showLoader();
        const params = new URLSearchParams(new FormData(this)).toString();
        fetch(`/api/team-head-to-head?${params}`).then(res => res.json()).then(data => {
            hideLoader();
            if (data.summary.message) { renderError(data.summary.message); return; }
            let resultsHtml = `<div class="col-lg-6 mb-4"><div class="card h-100"><div class="card-header">Overall Summary</div><div class="card-body"><div id="h2h-chart"></div></div></div></div><div class="col-lg-6 mb-4"><div class="card h-100"><div class="card-header">Toss & Streak Analysis</div><div class="card-body">${renderTable('Toss Impact', data.toss_analysis)}${renderTable('Longest Winning Streaks', data.streaks)}</div></div></div>`;
            for (const team in data.win_margins) { if (Object.keys(data.win_margins[team]).length > 0) { resultsHtml += `<div class="col-lg-6 mb-4">${renderTable(`Win Margin Analysis: ${team}`, data.win_margins[team])}</div>`; } }
            resultsContainer.innerHTML = resultsHtml;
            renderPlot('h2h-chart', [{ x: [team1, team2, 'Draws'], y: [data.summary[team1], data.summary[team2], data.summary.draws], type: 'bar', marker: { color: ['#0d6efd', '#6f42c1', '#6c757d'] } }], { title: `Match Wins (Total: ${data.summary.total_matches})`, yaxis: { title: 'Matches Won' } });
        }).catch(err => { hideLoader(); renderError('Failed to fetch Team H2H data.'); console.error(err); });
    });
    
    // --- Player Stats Handler (Corrected) ---
    document.getElementById('player-stats-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const player = this.elements.player.value;
        const role = this.elements.role.value;
        if (!player) { renderError("Please enter a player name."); return; }
        mainTitle.textContent = `Player Analysis`;
        resultsContainer.innerHTML = '';
        showLoader();

        const statsPromise = fetch(`/api/player-stats?player=${player}&role=${role}`);
        const phasePromise = fetch(`/api/phase-analysis?player=${player}&role=${role}`);
        
        Promise.all([statsPromise, phasePromise]).then(async ([statsResponse, phaseResponse]) => {
            hideLoader();
            if (!statsResponse.ok || !phaseResponse.ok) {
                renderError('Failed to fetch player data. The player may not exist.');
                return;
            }
            const statsData = await statsResponse.json();
            const phaseData = await phaseResponse.json();
            
            if (!statsData.summary || Object.keys(statsData.summary).length === 0) { renderError(`No data found for player: ${player}. Check the name or role.`); return; }
            mainTitle.textContent = `Analysis for ${statsData.corrected_name}`;
            
            let resultsHtml = `<div class="col-lg-5">${renderTable('Overall Summary', statsData.summary)}</div><div class="col-lg-7"><div id="phase-chart"></div></div>`;
            resultsContainer.innerHTML = resultsHtml;

            const phases = Object.keys(phaseData.stats);
            if (role === 'batsman') {
                const runs = phases.map(p => phaseData.stats[p].runs);
                const strikeRates = phases.map(p => phaseData.stats[p].strike_rate);
                renderPlot('phase-chart', [{ x: phases, y: runs, type: 'bar', name: 'Runs' }, { x: phases, y: strikeRates, type: 'scatter', name: 'Strike Rate', yaxis: 'y2' }], { title: 'Performance by Phase', yaxis: {title: 'Runs'}, yaxis2: { title: 'Strike Rate', overlaying: 'y', side: 'right' } });
            } else {
                const wickets = phases.map(p => phaseData.stats[p].wickets);
                const economy = phases.map(p => phaseData.stats[p].economy);
                renderPlot('phase-chart', [{ x: phases, y: wickets, type: 'bar', name: 'Wickets' }, { x: phases, y: economy, type: 'scatter', name: 'Economy', yaxis: 'y2' }], { title: 'Performance by Phase', yaxis: {title: 'Wickets'}, yaxis2: { title: 'Economy', overlaying: 'y', side: 'right' } });
            }
        }).catch(err => { hideLoader(); renderError("An error occurred while fetching player data."); console.error(err); });
    });

    // --- Player H2H Handler ---
    document.getElementById('player-h2h-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const batsman = this.elements.batsman.value;
        const bowler = this.elements.bowler.value;
        if (!batsman || !bowler) { renderError("Please provide both batsman and bowler names."); return; }
        mainTitle.textContent = `Player H2H: ${batsman} vs ${bowler}`;
        resultsContainer.innerHTML = '';
        showLoader();
        fetch(`/api/player-head-to-head?batsman=${batsman}&bowler=${bowler}`).then(res => res.json()).then(data => {
            hideLoader();
            if (data.error) { renderError(data.error); return; }
            mainTitle.textContent = `H2H: ${data.corrected_batsman} vs ${data.corrected_bowler}`;
            resultsContainer.innerHTML = `<div class="col-lg-6">${renderTable('Matchup Stats', data.stats)}</div>`;
        }).catch(err => { hideLoader(); renderError('Failed to fetch Player H2H data.'); console.error(err); });
    });

    // --- Venue Fortress Handler (Corrected) ---
    document.getElementById('venue-fortress-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const team = this.elements.team.value;
        if (!team) { renderError("Please select a team."); return; }
        mainTitle.textContent = `${team} - Venue Fortress`;
        resultsContainer.innerHTML = '';
        showLoader();
        fetch(`/api/venue-fortress?team=${team}`).then(res => res.json()).then(data => {
            hideLoader();
            if (!data.venues || data.venues.length === 0) {
                renderError(`No significant venue data found for ${team} (min. 5 matches required).`);
                return;
            }
            resultsContainer.innerHTML = `<div class="col-12"><div id="venue-chart"></div></div>`;
            renderPlot('venue-chart', [{ x: data.venues, y: data.win_percentages, type: 'bar' }], { title: `Team Win % at Venues (Min. 5 Matches)`, yaxis: { title: 'Win %' } });
        }).catch(err => { hideLoader(); renderError("Failed to fetch venue data."); console.error(err); });
    });

    // --- Win Predictor Handler (Corrected) ---
    document.getElementById('win-predictor-form').addEventListener('submit', function(e) {
        e.preventDefault();
        mainTitle.textContent = "Win Probability";
        resultsContainer.innerHTML = '';
        showLoader();
        const params = new URLSearchParams(new FormData(this)).toString();
        fetch(`/api/predict?${params}`).then(res => res.json()).then(data => {
            hideLoader();
            if (data.error) { renderError(data.error); return; }
            resultsContainer.innerHTML = `<div class="col-md-8"><div id="win-prob-chart"></div></div>`;
            renderPlot('win-prob-chart', [{ x: Object.values(data), y: Object.keys(data), type: 'bar', orientation: 'h', marker: { color: ['#0d6efd', '#6c757d'] } }], { title: 'Win Probability (%)', xaxis: { range: [0, 100] } });
        }).catch(err => { hideLoader(); renderError('Failed to fetch prediction.'); console.error(err); });
    });
});
</script>
</body>
</html>